<div class="builder-container">
  <!-- Left side - Form Editor -->
  <div class="form-editor">
    <p-panel header="App Builder" [toggleable]="false">
      <form [formGroup]="appForm">
        
        <!-- GitHub Integration or File Upload -->
        <div class="form-section">
          <h3>Import Configuration</h3>
          
          <!-- GitHub Connect (if not connected) -->
          <div *ngIf="!isGitHubConnected" class="github-connect">
            <p>Connect to GitHub to directly load and save protocol files from your repositories</p>
            <p-button 
              label="Connect to GitHub" 
              icon="pi pi-github" 
              (onClick)="connectToGitHub()"
              severity="info">
            </p-button>
          </div>

          <!-- Repository Selection -->
          <div *ngIf="isGitHubConnected" class="github-connected">
            <div class="field">
              <label for="repository">Select Repository</label>
              <p-select 
                [options]="repositories" 
                formControlName="selectedRepository"
                optionLabel="full_name"
                optionValue="full_name"
                placeholder="Choose a repository"
                (onChange)="onRepositorySelect($event.value)"
                styleClass="w-full github-select"
                [style]="{'width': '100%'}">
              </p-select>
            </div>

            <div class="field" *ngIf="appForm.get('selectedRepository')?.value">
              <label for="filePath">File Path</label>
              <input 
                id="filePath" 
                type="text" 
                pInputText 
                formControlName="filePath"
                placeholder="src/protocol.json"
                class="w-full"
              />
            </div>

            <div class="github-actions" *ngIf="appForm.get('selectedRepository')?.value">
              <p-button 
                label="Load from GitHub" 
                icon="pi pi-download" 
                (onClick)="loadFromGitHub()"
                severity="info"
                size="small">
              </p-button>
            </div>

            <p-message 
              *ngIf="gitHubError" 
              severity="error" 
              [text]="gitHubError">
            </p-message>
          </div>

          <!-- Legacy File Upload (hidden when GitHub connected) -->
          <div *ngIf="!isGitHubConnected" class="upload-container">
            <input 
              type="file" 
              accept=".json"
              (change)="onFileUpload($event)"
              class="file-input"
              id="file-upload"
            />
            <label for="file-upload" class="file-upload-label">
              <i class="pi pi-upload"></i>
              Upload protocol.json
            </label>
            <p-message 
              *ngIf="uploadError" 
              severity="error" 
              [text]="uploadError">
            </p-message>
          </div>
        </div>

        <p-divider></p-divider>

        <!-- Top-Level Protocol Properties -->
        <div class="form-section">
          <h3>Protocol Configuration</h3>
          <div class="p-fluid">
            <div class="field">
              <label for="icon">App Icon</label>
              <input 
                id="icon" 
                type="text" 
                pInputText 
                formControlName="icon" 
                placeholder="/assets/home_mindtrails.png"
              />
            </div>
            
            <div class="field">
              <label for="datums_endpoint">Datums Endpoint</label>
              <input 
                id="datums_endpoint" 
                type="text" 
                pInputText 
                formControlName="datums_endpoint" 
                placeholder="https://digital-trails.org/api/v1/datums"
              />
            </div>

            <div class="field">
              <label for="sessions">Sessions Flow</label>
              <input 
                id="sessions" 
                type="text" 
                pInputText 
                formControlName="sessions" 
                placeholder="flow://flows/doses"
              />
            </div>
          </div>
        </div>

        <p-divider></p-divider>

        <!-- Home Configuration -->
        <div class="form-section" formGroupName="home">
          <h3>Home Screen Configuration</h3>
          <div class="p-fluid">
            <div class="field">
              <label for="title">App Title</label>
              <input 
                id="title" 
                type="text" 
                pInputText 
                formControlName="title" 
                placeholder="Enter app title"
              />
            </div>

            <!-- Banner Configuration -->
            <h4>Banner Settings</h4>
            <div class="field">
              <label for="banner_text">Banner Text</label>
              <input 
                id="banner_text" 
                type="text" 
                pInputText 
                formControlName="banner_text" 
                placeholder="Single banner text"
              />
            </div>

            <div class="field">
              <label for="banner_text_1">Banner Text 1</label>
              <input 
                id="banner_text_1" 
                type="text" 
                pInputText 
                formControlName="banner_text_1" 
                placeholder="First line of banner"
              />
            </div>

            <div class="field">
              <label for="banner_text_2">Banner Text 2</label>
              <input 
                id="banner_text_2" 
                type="text" 
                pInputText 
                formControlName="banner_text_2" 
                placeholder="Second line of banner"
              />
            </div>

            <div class="field">
              <label for="banner_icon">Banner Icon</label>
              <input 
                id="banner_icon" 
                type="text" 
                pInputText 
                formControlName="banner_icon" 
                placeholder="/assets/home_banner.png"
              />
            </div>

            <!-- Button Configuration -->
            <h4>Button Configuration</h4>
            <div class="button-grid">
              <!-- Top-Left Button -->
              <div class="button-config" formGroupName="button_tl">
                <h5>Top-Left Button</h5>
                <div class="field">
                  <label>Button Text</label>
                  <input type="text" pInputText formControlName="text" placeholder="Button text" />
                </div>
                <div class="field">
                  <label>Icon</label>
                  <input type="text" pInputText formControlName="icon" placeholder="/assets/icon.png" />
                </div>
                <div class="field">
                  <label>Action</label>
                  <input type="text" pInputText formControlName="action" placeholder="flow://flows/example" />
                </div>
              </div>

              <!-- Top-Right Button -->
              <div class="button-config" formGroupName="button_tr">
                <h5>Top-Right Button</h5>
                <div class="field">
                  <label>Button Text</label>
                  <input type="text" pInputText formControlName="text" placeholder="Button text" />
                </div>
                <div class="field">
                  <label>Icon</label>
                  <input type="text" pInputText formControlName="icon" placeholder="/assets/icon.png" />
                </div>
                <div class="field">
                  <label>Action</label>
                  <input type="text" pInputText formControlName="action" placeholder="flow://flows/example" />
                </div>
              </div>

              <!-- Bottom-Left Button -->
              <div class="button-config" formGroupName="button_bl">
                <h5>Bottom-Left Button</h5>
                <div class="field">
                  <label>Button Text</label>
                  <input type="text" pInputText formControlName="text" placeholder="Button text" />
                </div>
                <div class="field">
                  <label>Icon</label>
                  <input type="text" pInputText formControlName="icon" placeholder="/assets/icon.png" />
                </div>
                <div class="field">
                  <label>Action</label>
                  <input type="text" pInputText formControlName="action" placeholder="flow://flows/example" />
                </div>
              </div>

              <!-- Bottom-Right Button -->
              <div class="button-config" formGroupName="button_br">
                <h5>Bottom-Right Button</h5>
                <div class="field">
                  <label>Button Text</label>
                  <input type="text" pInputText formControlName="text" placeholder="Button text" />
                </div>
                <div class="field">
                  <label>Icon</label>
                  <input type="text" pInputText formControlName="icon" placeholder="/assets/icon.png" />
                </div>
                <div class="field">
                  <label>Action</label>
                  <input type="text" pInputText formControlName="action" placeholder="flow://flows/example" />
                </div>
              </div>

              <!-- Left Sessions Button -->
              <div class="button-config" formGroupName="button_ls">
                <h5>Left Sessions Button</h5>
                <div class="field">
                  <label>Button Text</label>
                  <input type="text" pInputText formControlName="text" placeholder="{0} Sessions Completed" />
                </div>
                <div class="field">
                  <label>Icon</label>
                  <input type="text" pInputText formControlName="icon" placeholder="/assets/icon.png" />
                </div>
              </div>

              <!-- Right Sessions Button -->
              <div class="button-config" formGroupName="button_rs">
                <h5>Right Sessions Button</h5>
                <div class="field">
                  <label>Button Text</label>
                  <input type="text" pInputText formControlName="text" placeholder="Launch Session" />
                </div>
                <div class="field">
                  <label>Icon</label>
                  <input type="text" pInputText formControlName="icon" placeholder="/assets/icon.png" />
                </div>
                <div class="field">
                  <label>Action</label>
                  <input type="text" pInputText formControlName="action" placeholder="flow://flows/sessions" />
                </div>
              </div>

              <!-- Survey Button -->
              <div class="button-config" formGroupName="button_surveys">
                <h5>Survey Button</h5>
                <div class="field">
                  <label>Button Text</label>
                  <input type="text" pInputText formControlName="text" placeholder="Show Surveys" />
                </div>
                <div class="field">
                  <label>Action</label>
                  <input type="text" pInputText formControlName="action" placeholder="navmodal://Survey" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <p-divider></p-divider>

        <!-- JSON Preview -->
        <div class="form-section">
          <h3>Protocol JSON Preview</h3>
          <pre class="json-preview">{{ getProtocolPreview() | json }}</pre>
        </div>

        <!-- Save/Export Actions -->
        <div class="form-section">
          <div *ngIf="isGitHubConnected && appForm.get('selectedRepository')?.value" class="github-save-actions">
            <p-button 
              label="Save Changes to GitHub" 
              icon="pi pi-cloud-upload" 
              (onClick)="saveToGitHub()"
              severity="success">
            </p-button>
          </div>
          
          <div *ngIf="!isGitHubConnected || !appForm.get('selectedRepository')?.value" class="export-actions">
            <p-button 
              label="Export protocol.json" 
              icon="pi pi-download" 
              (onClick)="exportConfig()"
              severity="info">
            </p-button>
          </div>
        </div>
      </form>
    </p-panel>
  </div>

  <!-- Right side - Phone Preview -->
  <div class="phone-preview">
    <div class="phone-container">
      <!-- Phone Frame -->
      <div class="phone-frame" [class.light-theme]="!isDarkTheme">


        <!-- Main Content Area -->
        <div class="phone-content">
          <!-- Screen Navigator - Home Screen -->
          <div *ngIf="currentView === 'home'" class="screen-home">
            <!-- Alert/Status Bar -->
            <div class="alert-element">
              <div class="alert-header">
                <span class="alert-title">Running {{ appData.title }}</span>
                <span class="hexagon-icon">⬡</span>
              </div>
              <p class="alert-message">{{ appData.subtitle }}</p>
            </div>

            <!-- Top Tiles -->
            <div class="top-tiles">
              <button class="app-button tile-neutral">
                <span class="tile-text">0 Sessions Completed</span>
              </button>
              
              <button class="app-button tile-launch">
                <span class="tile-text">Launch Session</span>
              </button>
            </div>

            <!-- Show Surveys Button -->
            <div class="surveys-section">
              <button class="surveys-btn" (click)="navigateToSurveys()">Show Surveys</button>
            </div>

            <!-- Bottom Tiles -->
            <div class="bottom-tiles">
              <button class="app-button tile-blue">
                <span class="tile-text">{{ appData.button1 }}</span>
              </button>
              
              <button class="app-button tile-green">
                <span class="tile-text">{{ appData.button2 }}</span>
              </button>
              
              <button class="app-button tile-teal">
                <span class="tile-text">{{ appData.button3 }}</span>
              </button>
              
              <button class="app-button tile-purple">
                <span class="tile-text">{{ appData.button4 }}</span>
              </button>
            </div>
          </div>

          <!-- Surveys Screen -->
          <div *ngIf="currentView === 'surveys'" class="screen-surveys">
            <!-- Success Toast -->
            <div *ngIf="showSuccessToast" class="success-toast">
              <div class="toast-content">
                <span class="toast-icon">✅</span>
                <span class="toast-message">Survey completed successfully!</span>
              </div>
            </div>

            <div class="surveys-content">
              <div class="survey-item" *ngFor="let survey of surveysData" (click)="startSurvey(survey.id)">
                <div class="survey-content">
                  <span class="survey-icon">{{ survey.icon }}</span>
                  <span class="survey-text">{{ survey.name }}</span>
                  <span class="survey-arrow">></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Survey Question Screen -->
          <div *ngIf="currentView === 'survey-question'" class="screen-survey-question">
            <div class="question-content" *ngIf="getCurrentQuestion() as question">
              <!-- Progress indicator -->
              <div class="question-progress">
                <div class="progress-bar">
                  <div class="progress-fill" [style.width.%]="((currentQuestionIndex + 1) / currentSurvey.questions.length) * 100"></div>
                </div>
                <span class="progress-text">{{ currentQuestionIndex + 1 }} of {{ currentSurvey.questions.length }}</span>
              </div>

              <!-- Question -->
              <div class="question-header">
                <h3 class="question-title">{{ question.question }}</h3>
              </div>

              <!-- Answer options -->
              <div class="answer-options">
                <div 
                  class="answer-option" 
                  *ngFor="let option of question.options"
                  [class.selected]="getCurrentAnswer() === option"
                  (click)="selectAnswer(option)">
                  <span class="option-text">{{ option }}</span>
                  <span class="option-check" *ngIf="getCurrentAnswer() === option">✓</span>
                </div>
              </div>

              <!-- Navigation buttons -->
              <div class="question-actions">
                <button class="back-btn" (click)="navigateToSurveys()">
                  <i class="pi pi-arrow-left"></i>
                  Back to Surveys
                </button>
                <button 
                  class="next-btn" 
                  [disabled]="!canProceed()"
                  (click)="nextQuestion()">
                  {{ currentQuestionIndex === currentSurvey.questions.length - 1 ? 'Complete' : 'Next' }}
                  <i class="pi pi-arrow-right" *ngIf="currentQuestionIndex < currentSurvey.questions.length - 1"></i>
                  <i class="pi pi-check" *ngIf="currentQuestionIndex === currentSurvey.questions.length - 1"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Settings Screen -->
          <div *ngIf="currentView === 'settings'" class="screen-settings">
            <div class="settings-content">
              <div class="settings-item" *ngFor="let item of settingsItems; let i = index">
                <span class="settings-text">{{ item.label }}</span>
                <span class="settings-action">
                  <span *ngIf="item.type === 'toggle'" 
                        class="toggle-switch" 
                        [class.active]="item.value"
                        (click)="onSettingsToggle(i)">⚪</span>
                  <span *ngIf="item.type === 'arrow'" class="settings-arrow">></span>
                </span>
              </div>
            </div>
          </div>

          <!-- Action Screen -->
          <div *ngIf="currentScreen.type === 'action'" class="screen-action">
            <div class="action-content">
              <img *ngIf="currentScreen.content?.action.icon" 
                   [src]="currentScreen.content.action.icon" 
                   alt="Action Icon" 
                   class="action-icon">
              
              <h3 class="action-title">{{ currentScreen.content?.action.text }}</h3>
              
              <p class="action-description">
                This is a details screen for the action: {{ currentScreen.content?.action.text }}.
                <br>
                Action URL: {{ currentScreen.content?.action.action }}
              </p>

              <div class="action-buttons">
                <button class="action-button primary" (click)="navigateToHome()">
                  Back to Home
                </button>
              </div>
            </div>
          </div>

          <!-- Sessions Screen -->
          <div *ngIf="currentScreen.type === 'session'" class="screen-session">
            <div class="session-content">
              <h3 class="session-title">{{ currentScreen.title }}</h3>
              
              <p class="session-description">
                This is a session details screen for: {{ currentScreen.title }}.
                <br>
                Session action: {{ currentScreen.content?.right?.action }}
              </p>

              <div class="session-info">
                <div class="session-info-item">
                  <span class="info-label">Status:</span>
                  <span class="info-value">Active</span>
                </div>
                <div class="session-info-item">
                  <span class="info-label">Created:</span>
                  <span class="info-value">{{ today | date:'medium' }}</span>
                </div>
              </div>

              <div class="session-buttons">
                <button class="session-button primary" (click)="navigateToHome()">
                  Back to Home
                </button>
              </div>
            </div>
          </div>

          <!-- Button Screen -->
          <div *ngIf="currentScreen.type === 'button'" class="screen-button">
            <div class="button-content">
              <h3 class="button-title">{{ currentScreen.title }}</h3>
              
              <p class="button-description">
                This is a button action screen for: {{ currentScreen.title }}.
                <br>
                Action URL: {{ currentScreen.content?.action?.action }}
              </p>

              <div class="button-buttons">
                <button class="button-button primary" (click)="navigateToHome()">
                  Back to Home
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Phone Footer -->
        <div class="phone-footer">
          <div class="footer-buttons">
            <button class="footer-btn" (click)="navigateToMenu()">
              <i class="pi pi-bars"></i>
              <span>Menu</span>
            </button>
            <button class="footer-btn" [class.active]="currentView === 'home'" (click)="navigateToHome()">
              <i class="pi pi-home"></i>
              <span>Home</span>
            </button>
            <button class="footer-btn" [class.active]="currentView === 'settings'" (click)="navigateToSettings()">
              <i class="pi pi-cog"></i>
              <span>Settings</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Screen Indicator -->
      <div class="screen-indicator" *ngIf="screens.length > 1">
        <div class="screen-info">
          <span class="current-screen">{{ currentScreenIndex + 1 }}</span>
          <span class="total-screens">/{{ screens.length }}</span>
        </div>
      </div>
      
      <!-- Preview Controls -->
      <div class="preview-controls">
        <p-button 
          icon="pi pi-arrow-left" 
          [disabled]="currentScreenIndex === 0"
          (onClick)="navigateBack()"
          severity="secondary"
          size="small"
          tooltipPosition="top"
          pTooltip="Previous Screen">
        </p-button>
        
        <p-button 
          icon="pi pi-home" 
          [disabled]="currentScreenIndex === 0"
          (onClick)="navigateToHome()"
          severity="secondary"
          size="small"
          tooltipPosition="top"
          pTooltip="Home Screen">
        </p-button>
        
        <p-button 
          label="Next" 
          icon="pi pi-images"
          (onClick)="currentScreenIndex = (currentScreenIndex + 1) % screens.length" 
          severity="info"
          size="small"
          [disabled]="screens.length <= 1"
          tooltipPosition="top"
          pTooltip="Cycle through available screens">
        </p-button>
      </div>
      
      <!-- Control Instructions -->
      <div class="control-instructions" *ngIf="screens.length > 1">
        <span class="instruction-text">Cycle through available screens</span>
      </div>

    </div>
  </div>
</div>
