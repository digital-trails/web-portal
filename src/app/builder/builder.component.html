<div class="builder-container">
  <!-- Left side - Form Editor -->
  <div class="form-editor">
    <p-panel header="App Builder" [toggleable]="false">
      <form [formGroup]="appForm">
        
        <!-- GitHub Integration or File Upload -->
        <div class="form-section">
          <h3>Import Configuration</h3>
          
          <!-- GitHub Connect (if not connected) -->
          <div *ngIf="!isGitHubConnected" class="github-connect">
            <p>Connect to GitHub to directly load and save protocol files from your repositories</p>
            <p-button 
              label="Connect to GitHub" 
              icon="pi pi-github" 
              (onClick)="connectToGitHub()"
              severity="info">
            </p-button>
          </div>

          <!-- Repository Selection -->
          <div *ngIf="isGitHubConnected" class="github-connected">
            <div class="field">
              <label for="repository">Select Repository</label>
              <p-select 
                [options]="repositories" 
                formControlName="selectedRepository"
                optionLabel="full_name"
                optionValue="full_name"
                placeholder="Choose a repository"
                (onChange)="onRepositorySelect($event.value)"
                styleClass="w-full github-select"
                [style]="{'width': '100%'}">
              </p-select>
            </div>

            <div class="field" *ngIf="appForm.get('selectedRepository')?.value">
              <label for="filePath">File Path</label>
              <input 
                id="filePath" 
                type="text" 
                pInputText 
                formControlName="filePath"
                placeholder="src/protocol.json"
                class="w-full"
              />
            </div>

            <div class="github-actions" *ngIf="appForm.get('selectedRepository')?.value">
              <p-button 
                label="Load from GitHub" 
                icon="pi pi-download" 
                (onClick)="loadFromGitHub()"
                severity="info"
                size="small">
              </p-button>
            </div>

            <p-message 
              *ngIf="gitHubError" 
              severity="error" 
              [text]="gitHubError">
            </p-message>
          </div>

          <!-- Legacy File Upload (hidden when GitHub connected) -->
          <div *ngIf="!isGitHubConnected" class="upload-container">
            <input 
              type="file" 
              accept=".json"
              (change)="onFileUpload($event)"
              class="file-input"
              id="file-upload"
            />
            <label for="file-upload" class="file-upload-label">
              <i class="pi pi-upload"></i>
              Upload protocol.json
            </label>
            <p-message 
              *ngIf="uploadError" 
              severity="error" 
              [text]="uploadError">
            </p-message>
          </div>
        </div>

        <p-divider></p-divider>

        <!-- Basic Information -->
        <div class="form-section">
          <h3>Basic Information</h3>
          <div class="p-fluid">
            <div class="field">
              <label for="title">App Title</label>
              <input 
                id="title" 
                type="text" 
                pInputText 
                formControlName="title" 
                placeholder="Enter app title"
              />
            </div>
            
            <div class="field">
              <label for="subtitle">Subtitle</label>
              <input 
                id="subtitle" 
                type="text" 
                pInputText 
                formControlName="subtitle" 
                placeholder="Enter subtitle"
              />
            </div>

            <div class="field">
              <label for="appIcon">App Icon URL</label>
              <input 
                id="appIcon" 
                type="text" 
                pInputText 
                formControlName="appIcon" 
                placeholder="Enter app icon URL"
              />
            </div>
          </div>
        </div>

        <p-divider></p-divider>

        <!-- Legacy Buttons Section -->
        <div class="form-section">
          <h3>Button Labels (Legacy Support)</h3>
          <div class="p-fluid">
            <div class="field">
              <label for="button1">Button 1</label>
              <input 
                id="button1" 
                type="text" 
                pInputText 
                formControlName="button1" 
                placeholder="Button 1 text"
              />
            </div>
            
            <div class="field">
              <label for="button2">Button 2</label>
              <input 
                id="button2" 
                type="text" 
                pInputText 
                formControlName="button2" 
                placeholder="Button 2 text"
              />
            </div>
            
            <div class="field">
              <label for="button3">Button 3</label>
              <input 
                id="button3" 
                type="text" 
                pInputText 
                formControlName="button3" 
                placeholder="Button 3 text"
              />
            </div>
            
            <div class="field">
              <label for="button4">Button 4</label>
              <input 
                id="button4" 
                type="text" 
                pInputText 
                formControlName="button4" 
                placeholder="Button 4 text"
              />
            </div>
          </div>
        </div>

        <p-divider></p-divider>

        <!-- Survey Configuration Section -->
        <div class="form-section">
          <h3>Survey Configuration</h3>
          <div class="p-fluid">
            <!-- Survey Names -->
            <div class="field">
              <label for="survey1Name">Survey 1 Name</label>
              <input 
                id="survey1Name" 
                type="text" 
                pInputText 
                formControlName="survey1Name" 
                placeholder="First survey name"
              />
            </div>
            
            <div class="field">
              <label for="survey2Name">Survey 2 Name</label>
              <input 
                id="survey2Name" 
                type="text" 
                pInputText 
                formControlName="survey2Name" 
                placeholder="Second survey name"
              />
            </div>

            <!-- Survey 1 Questions -->
            <h4>Survey 1 Questions</h4>
            <div class="survey-questions">
              <div class="question-group">
                <label for="survey1Q1">Question 1</label>
                <input 
                  id="survey1Q1" 
                  type="text" 
                  pInputText 
                  formControlName="survey1Q1" 
                  placeholder="Enter question text"
                />
                <label for="survey1Q1Options">Answer Options (separate with | - max 4 options)</label>
                <input 
                  id="survey1Q1Options" 
                  type="text" 
                  pInputText 
                  formControlName="survey1Q1Options" 
                  placeholder="Option 1|Option 2|Option 3|Option 4"
                />
              </div>

              <div class="question-group">
                <label for="survey1Q2">Question 2</label>
                <input 
                  id="survey1Q2" 
                  type="text" 
                  pInputText 
                  formControlName="survey1Q2" 
                  placeholder="Enter question text"
                />
                <label for="survey1Q2Options">Answer Options (separate with | - max 4 options)</label>
                <input 
                  id="survey1Q2Options" 
                  type="text" 
                  pInputText 
                  formControlName="survey1Q2Options" 
                  placeholder="Option 1|Option 2|Option 3|Option 4"
                />
              </div>

              <div class="question-group">
                <label for="survey1Q3">Question 3</label>
                <input 
                  id="survey1Q3" 
                  type="text" 
                  pInputText 
                  formControlName="survey1Q3" 
                  placeholder="Enter question text"
                />
                <label for="survey1Q3Options">Answer Options (separate with | - max 4 options)</label>
                <input 
                  id="survey1Q3Options" 
                  type="text" 
                  pInputText 
                  formControlName="survey1Q3Options" 
                  placeholder="Option 1|Option 2|Option 3|Option 4"
                />
              </div>
            </div>

            <!-- Survey 2 Questions -->
            <h4>Survey 2 Questions</h4>
            <div class="survey-questions">
              <div class="question-group">
                <label for="survey2Q1">Question 1</label>
                <input 
                  id="survey2Q1" 
                  type="text" 
                  pInputText 
                  formControlName="survey2Q1" 
                  placeholder="Enter question text"
                />
                <label for="survey2Q1Options">Answer Options (separate with | - max 4 options)</label>
                <input 
                  id="survey2Q1Options" 
                  type="text" 
                  pInputText 
                  formControlName="survey2Q1Options" 
                  placeholder="Option 1|Option 2|Option 3|Option 4"
                />
              </div>

              <div class="question-group">
                <label for="survey2Q2">Question 2</label>
                <input 
                  id="survey2Q2" 
                  type="text" 
                  pInputText 
                  formControlName="survey2Q2" 
                  placeholder="Enter question text"
                />
                <label for="survey2Q2Options">Answer Options (separate with | - max 4 options)</label>
                <input 
                  id="survey2Q2Options" 
                  type="text" 
                  pInputText 
                  formControlName="survey2Q2Options" 
                  placeholder="Option 1|Option 2|Option 3|Option 4"
                />
              </div>

              <div class="question-group">
                <label for="survey2Q3">Question 3</label>
                <input 
                  id="survey2Q3" 
                  type="text" 
                  pInputText 
                  formControlName="survey2Q3" 
                  placeholder="Enter question text"
                />
                <label for="survey2Q3Options">Answer Options (separate with | - max 4 options)</label>
                <input 
                  id="survey2Q3Options" 
                  type="text" 
                  pInputText 
                  formControlName="survey2Q3Options" 
                  placeholder="Option 1|Option 2|Option 3|Option 4"
                />
              </div>
            </div>
          </div>
        </div>

        <p-divider></p-divider>

        <!-- Dynamic Elements Section -->
        <div class="form-section">
          <h3>App Elements</h3>
          
          <!-- Add Element Buttons -->
          <div class="add-element-buttons">
            <p-button 
              label="Add Alert" 
              icon="pi pi-info-circle" 
              (onClick)="addNewElement('alert')"
              severity="secondary"
              size="small">
            </p-button>
            <p-button 
              label="Add Sessions" 
              icon="pi pi-calendar" 
              (onClick)="addNewElement('sessions')"
              severity="secondary"
              size="small">
            </p-button>
            <p-button 
              label="Add Button" 
              icon="pi pi-plus" 
              (onClick)="addNewElement('button')"
              severity="secondary"
              size="small">
            </p-button>
            <p-button 
              label="Add Carousel" 
              icon="pi pi-images" 
              (onClick)="addNewElement('carousel')"
              severity="secondary"
              size="small">
            </p-button>
            <p-button 
              label="Add Tiles" 
              icon="pi pi-th-large" 
              (onClick)="addNewElement('tiles')"
              severity="secondary"
              size="small">
            </p-button>
          </div>

          <!-- Dynamic Elements Forms -->
          <div formArrayName="elements">
            <div *ngFor="let elementForm of elementsArray.controls; let i = index" 
                 [formGroupName]="i" 
                 class="element-form">
              
              <!-- Element Header -->
              <div class="element-header">
                <span class="element-type">{{ elementForm.get('type')?.value | titlecase }}</span>
                <p-button 
                  icon="pi pi-trash" 
                  (onClick)="removeElement(i)"
                  severity="danger"
                  size="small"
                  [text]="true">
                </p-button>
              </div>

              <!-- Alert Element -->
              <div *ngIf="elementForm.get('type')?.value === 'alert'" class="element-content">
                <div class="field">
                  <label>Alert Title</label>
                  <input type="text" pInputText formControlName="title" placeholder="Alert title" />
                </div>
                <div class="field">
                  <label>Alert Message</label>
                  <input type="text" pInputText formControlName="message" placeholder="Alert message" />
                </div>
                <div class="field">
                  <label>Icon URL</label>
                  <input type="text" pInputText formControlName="iconUrl" placeholder="Icon URL" />
                </div>
                <div class="field">
                  <label>Icon Tint</label>
                  <p-checkbox formControlName="iconTint" [binary]="true"></p-checkbox>
                </div>
              </div>

              <!-- Sessions Element -->
              <div *ngIf="elementForm.get('type')?.value === 'sessions'" class="element-content">
                <div class="field">
                  <label>Left Text</label>
                  <input type="text" pInputText formControlName="leftText" placeholder="Left side text" />
                </div>
                <div class="field">
                  <label>Left Icon</label>
                  <input type="text" pInputText formControlName="leftIcon" placeholder="Left icon URL" />
                </div>
                <div class="field">
                  <label>Right Text</label>
                  <input type="text" pInputText formControlName="rightText" placeholder="Right side text" />
                </div>
                <div class="field">
                  <label>Right Icon</label>
                  <input type="text" pInputText formControlName="rightIcon" placeholder="Right icon URL" />
                </div>
                <div class="field">
                  <label>Right Action</label>
                  <input type="text" pInputText formControlName="rightAction" placeholder="Action URL" />
                </div>
              </div>

              <!-- Button Element -->
              <div *ngIf="elementForm.get('type')?.value === 'button'" class="element-content">
                <div class="field">
                  <label>Button Text</label>
                  <input type="text" pInputText formControlName="actionText" placeholder="Button text" />
                </div>
                <div class="field">
                  <label>Action URL</label>
                  <input type="text" pInputText formControlName="actionUrl" placeholder="Action URL" />
                </div>
              </div>

              <!-- Carousel/Tiles Element -->
              <div *ngIf="elementForm.get('type')?.value === 'carousel' || elementForm.get('type')?.value === 'tiles'" class="element-content">
                <p>Actions configuration for {{ elementForm.get('type')?.value }} (Advanced editing available after upload)</p>
              </div>

            </div>
          </div>
        </div>

        <!-- Save/Export Actions -->
        <div class="form-section">
          <div *ngIf="isGitHubConnected && appForm.get('selectedRepository')?.value" class="github-save-actions">
            <p-button 
              label="Save Changes to GitHub" 
              icon="pi pi-upload" 
              (onClick)="saveToGitHub()"
              severity="success"
              [disabled]="!currentFileData">
            </p-button>
          </div>
          
          <div *ngIf="!isGitHubConnected" class="export-actions">
            <p-button 
              label="Export Config" 
              icon="pi pi-download" 
              (onClick)="exportConfig()"
              severity="secondary">
            </p-button>
          </div>
        </div>
      </form>
    </p-panel>
  </div>

  <!-- Right side - Phone Preview -->
  <div class="phone-preview">
    <div class="phone-container">
      <!-- Phone Frame -->
      <div class="phone-frame" [class.light-theme]="!isDarkTheme">


        <!-- Main Content Area -->
        <div class="phone-content">
          <!-- Screen Navigator - Home Screen -->
          <div *ngIf="currentView === 'home'" class="screen-home">
            <!-- Alert/Status Bar -->
            <div class="alert-element">
              <div class="alert-header">
                <span class="alert-title">Running {{ appData.title }}</span>
                <span class="hexagon-icon">⬡</span>
              </div>
              <p class="alert-message">{{ appData.subtitle }}</p>
            </div>

            <!-- Top Tiles -->
            <div class="top-tiles">
              <button class="app-button tile-neutral">
                <span class="tile-text">0 Sessions Completed</span>
              </button>
              
              <button class="app-button tile-launch">
                <span class="tile-text">Launch Session</span>
              </button>
            </div>

            <!-- Show Surveys Button -->
            <div class="surveys-section">
              <button class="surveys-btn" (click)="navigateToSurveys()">Show Surveys</button>
            </div>

            <!-- Bottom Tiles -->
            <div class="bottom-tiles">
              <button class="app-button tile-blue">
                <span class="tile-text">{{ appData.button1 }}</span>
              </button>
              
              <button class="app-button tile-green">
                <span class="tile-text">{{ appData.button2 }}</span>
              </button>
              
              <button class="app-button tile-teal">
                <span class="tile-text">{{ appData.button3 }}</span>
              </button>
              
              <button class="app-button tile-purple">
                <span class="tile-text">{{ appData.button4 }}</span>
              </button>
            </div>
          </div>

          <!-- Surveys Screen -->
          <div *ngIf="currentView === 'surveys'" class="screen-surveys">
            <!-- Success Toast -->
            <div *ngIf="showSuccessToast" class="success-toast">
              <div class="toast-content">
                <span class="toast-icon">✅</span>
                <span class="toast-message">Survey completed successfully!</span>
              </div>
            </div>

            <div class="surveys-content">
              <div class="survey-item" *ngFor="let survey of surveysData" (click)="startSurvey(survey.id)">
                <div class="survey-content">
                  <span class="survey-icon">{{ survey.icon }}</span>
                  <span class="survey-text">{{ survey.name }}</span>
                  <span class="survey-arrow">></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Survey Question Screen -->
          <div *ngIf="currentView === 'survey-question'" class="screen-survey-question">
            <div class="question-content" *ngIf="getCurrentQuestion() as question">
              <!-- Progress indicator -->
              <div class="question-progress">
                <div class="progress-bar">
                  <div class="progress-fill" [style.width.%]="((currentQuestionIndex + 1) / currentSurvey.questions.length) * 100"></div>
                </div>
                <span class="progress-text">{{ currentQuestionIndex + 1 }} of {{ currentSurvey.questions.length }}</span>
              </div>

              <!-- Question -->
              <div class="question-header">
                <h3 class="question-title">{{ question.question }}</h3>
              </div>

              <!-- Answer options -->
              <div class="answer-options">
                <div 
                  class="answer-option" 
                  *ngFor="let option of question.options"
                  [class.selected]="getCurrentAnswer() === option"
                  (click)="selectAnswer(option)">
                  <span class="option-text">{{ option }}</span>
                  <span class="option-check" *ngIf="getCurrentAnswer() === option">✓</span>
                </div>
              </div>

              <!-- Navigation buttons -->
              <div class="question-actions">
                <button class="back-btn" (click)="navigateToSurveys()">
                  <i class="pi pi-arrow-left"></i>
                  Back to Surveys
                </button>
                <button 
                  class="next-btn" 
                  [disabled]="!canProceed()"
                  (click)="nextQuestion()">
                  {{ currentQuestionIndex === currentSurvey.questions.length - 1 ? 'Complete' : 'Next' }}
                  <i class="pi pi-arrow-right" *ngIf="currentQuestionIndex < currentSurvey.questions.length - 1"></i>
                  <i class="pi pi-check" *ngIf="currentQuestionIndex === currentSurvey.questions.length - 1"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Settings Screen -->
          <div *ngIf="currentView === 'settings'" class="screen-settings">
            <div class="settings-content">
              <div class="settings-item" *ngFor="let item of settingsItems; let i = index">
                <span class="settings-text">{{ item.label }}</span>
                <span class="settings-action">
                  <span *ngIf="item.type === 'toggle'" 
                        class="toggle-switch" 
                        [class.active]="item.value"
                        (click)="onSettingsToggle(i)">⚪</span>
                  <span *ngIf="item.type === 'arrow'" class="settings-arrow">></span>
                </span>
              </div>
            </div>
          </div>

          <!-- Action Screen -->
          <div *ngIf="currentScreen.type === 'action'" class="screen-action">
            <div class="action-content">
              <img *ngIf="currentScreen.content?.action.icon" 
                   [src]="currentScreen.content.action.icon" 
                   alt="Action Icon" 
                   class="action-icon">
              
              <h3 class="action-title">{{ currentScreen.content?.action.text }}</h3>
              
              <p class="action-description">
                This is a details screen for the action: {{ currentScreen.content?.action.text }}.
                <br>
                Action URL: {{ currentScreen.content?.action.action }}
              </p>

              <div class="action-buttons">
                <button class="action-button primary" (click)="navigateToHome()">
                  Back to Home
                </button>
              </div>
            </div>
          </div>

          <!-- Sessions Screen -->
          <div *ngIf="currentScreen.type === 'session'" class="screen-session">
            <div class="session-content">
              <h3 class="session-title">{{ currentScreen.title }}</h3>
              
              <p class="session-description">
                This is a session details screen for: {{ currentScreen.title }}.
                <br>
                Session action: {{ currentScreen.content?.right?.action }}
              </p>

              <div class="session-info">
                <div class="session-info-item">
                  <span class="info-label">Status:</span>
                  <span class="info-value">Active</span>
                </div>
                <div class="session-info-item">
                  <span class="info-label">Created:</span>
                  <span class="info-value">{{ today | date:'medium' }}</span>
                </div>
              </div>

              <div class="session-buttons">
                <button class="session-button primary" (click)="navigateToHome()">
                  Back to Home
                </button>
              </div>
            </div>
          </div>

          <!-- Button Screen -->
          <div *ngIf="currentScreen.type === 'button'" class="screen-button">
            <div class="button-content">
              <h3 class="button-title">{{ currentScreen.title }}</h3>
              
              <p class="button-description">
                This is a button action screen for: {{ currentScreen.title }}.
                <br>
                Action URL: {{ currentScreen.content?.action?.action }}
              </p>

              <div class="button-buttons">
                <button class="button-button primary" (click)="navigateToHome()">
                  Back to Home
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Phone Footer -->
        <div class="phone-footer">
          <div class="footer-buttons">
            <button class="footer-btn" (click)="navigateToMenu()">
              <i class="pi pi-bars"></i>
              <span>Menu</span>
            </button>
            <button class="footer-btn" [class.active]="currentView === 'home'" (click)="navigateToHome()">
              <i class="pi pi-home"></i>
              <span>Home</span>
            </button>
            <button class="footer-btn" [class.active]="currentView === 'settings'" (click)="navigateToSettings()">
              <i class="pi pi-cog"></i>
              <span>Settings</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Screen Indicator -->
      <div class="screen-indicator" *ngIf="screens.length > 1">
        <div class="screen-info">
          <span class="current-screen">{{ currentScreenIndex + 1 }}</span>
          <span class="total-screens">/{{ screens.length }}</span>
        </div>
      </div>
      
      <!-- Preview Controls -->
      <div class="preview-controls">
        <p-button 
          icon="pi pi-arrow-left" 
          [disabled]="currentScreenIndex === 0"
          (onClick)="navigateBack()"
          severity="secondary"
          size="small"
          tooltipPosition="top"
          pTooltip="Previous Screen">
        </p-button>
        
        <p-button 
          icon="pi pi-home" 
          [disabled]="currentScreenIndex === 0"
          (onClick)="navigateToHome()"
          severity="secondary"
          size="small"
          tooltipPosition="top"
          pTooltip="Home Screen">
        </p-button>
        
        <p-button 
          label="Next" 
          icon="pi pi-images"
          (onClick)="currentScreenIndex = (currentScreenIndex + 1) % screens.length" 
          severity="info"
          size="small"
          [disabled]="screens.length <= 1"
          tooltipPosition="top"
          pTooltip="Cycle through available screens">
        </p-button>
      </div>
      
      <!-- Control Instructions -->
      <div class="control-instructions" *ngIf="screens.length > 1">
        <span class="instruction-text">Cycle through available screens</span>
      </div>

    </div>
  </div>
</div>
